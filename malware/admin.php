<?php
// Simple admin interface for monitoring the EICAR download system
header('Content-Type: text/html; charset=utf-8');

// Get statistics
function getStats() {
    $logFile = 'downloads.log';
    $requestsFile = 'requests.log';
    
    $stats = [
        'downloads' => ['total' => 0, 'today' => 0, 'recent' => []],
        'requests' => ['total' => 0, 'recent' => []],
        'files' => [
            'logs_exist' => file_exists($logFile),
            'requests_exist' => file_exists($requestsFile),
            'log_size' => file_exists($logFile) ? filesize($logFile) : 0,
            'requests_size' => file_exists($requestsFile) ? filesize($requestsFile) : 0
        ]
    ];
    
    // Parse download logs
    if (file_exists($logFile)) {
        $logs = file($logFile, FILE_IGNORE_NEW_LINES);
        $stats['downloads']['total'] = count($logs);
        
        $today = date('Y-m-d');
        foreach ($logs as $log) {
            $data = json_decode(substr($log, 20), true); // Skip timestamp prefix
            if ($data) {
                if (strpos($log, $today) === 0) {
                    $stats['downloads']['today']++;
                }
                $stats['downloads']['recent'][] = $data;
            }
        }
        $stats['downloads']['recent'] = array_slice(array_reverse($stats['downloads']['recent']), 0, 10);
    }
    
    // Parse request logs
    if (file_exists($requestsFile)) {
        $requests = file($requestsFile, FILE_IGNORE_NEW_LINES);
        foreach ($requests as $request) {
            $data = json_decode($request, true);
            if ($data) {
                $stats['requests']['recent'][] = $data;
            }
        }
        $stats['requests']['total'] = count($stats['requests']['recent']);
        $stats['requests']['recent'] = array_slice(array_reverse($stats['requests']['recent']), 0, 20);
    }
    
    return $stats;
}

$stats = getStats();
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EICAR Download System - Admin</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            background: #88392B;
            color: white;
            padding: 20px;
            margin: -20px -20px 20px -20px;
            border-radius: 8px 8px 0 0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            border-left: 4px solid #88392B;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #88392B;
        }
        .log-section {
            margin: 30px 0;
        }
        .log-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .log-table th, .log-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .log-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .api-endpoints {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            margin-top: 20px;
        }
        .endpoint {
            font-family: monospace;
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 4px;
            margin: 5px 0;
            display: inline-block;
        }
        .refresh-btn {
            background: #88392B;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .refresh-btn:hover {
            background: #6d2e22;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>EICAR Download System - Administration</h1>
            <p>Monitor chunked malware simulation downloads and system health</p>
        </div>
        
        <button class="refresh-btn" onclick="location.reload()">🔄 Refresh Data</button>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number"><?= $stats['downloads']['total'] ?></div>
                <div>Total Downloads</div>
            </div>
            <div class="stat-card">
                <div class="stat-number"><?= $stats['downloads']['today'] ?></div>
                <div>Downloads Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-number"><?= $stats['requests']['total'] ?></div>
                <div>Total Requests</div>
            </div>
            <div class="stat-card">
                <div class="stat-number"><?= $stats['files']['log_size'] ?> B</div>
                <div>Log File Size</div>
            </div>
        </div>
        
        <div class="log-section">
            <h2>Recent Downloads</h2>
            <table class="log-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>IP Address</th>
                        <th>Chunks</th>
                        <th>Method</th>
                        <th>User Agent</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($stats['downloads']['recent'] as $download): ?>
                    <tr>
                        <td><?= htmlspecialchars($download['timestamp']) ?></td>
                        <td><?= htmlspecialchars($download['ip']) ?></td>
                        <td><?= htmlspecialchars($download['chunksProcessed']) ?></td>
                        <td><?= htmlspecialchars($download['assemblyMethod']) ?></td>
                        <td><?= htmlspecialchars(substr($download['userAgent'], 0, 50)) ?>...</td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
        
        <div class="log-section">
            <h2>Recent API Requests</h2>
            <table class="log-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>IP Address</th>
                        <th>Endpoint</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($stats['requests']['recent'] as $request): ?>
                    <tr>
                        <td><?= date('H:i:s', $request['timestamp']) ?></td>
                        <td><?= htmlspecialchars($request['ip']) ?></td>
                        <td><?= htmlspecialchars($request['endpoint']) ?></td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
        
        <div class="api-endpoints">
            <h2>Available API Endpoints</h2>
            <p><strong>GET Endpoints:</strong></p>
            <div class="endpoint">GET /process.php?chunk=1</div> - Fetch chunk 1<br>
            <div class="endpoint">GET /process.php?chunk=2</div> - Fetch chunk 2<br>
            <div class="endpoint">GET /process.php?chunk=3</div> - Fetch chunk 3<br>
            <div class="endpoint">GET /process.php?info=1</div> - Get chunk information<br>
            <div class="endpoint">GET /process.php?stats=1</div> - Get download statistics<br>
            <div class="endpoint">GET /process.php?health=1</div> - Health check<br>
            
            <p><strong>POST Endpoints:</strong></p>
            <div class="endpoint">POST /process.php</div> - Log download attempt<br>
        </div>
        
        <div style="margin-top: 30px; padding: 20px; background: #e3f2fd; border-radius: 6px;">
            <h3>System Status</h3>
            <ul>
                <li>Download logs: <?= $stats['files']['logs_exist'] ? '✅ Available' : '❌ Not found' ?></li>
                <li>Request logs: <?= $stats['files']['requests_exist'] ? '✅ Available' : '❌ Not found' ?></li>
                <li>Rate limiting: ✅ Active (30 requests/minute)</li>
                <li>CORS: ✅ Enabled for all origins</li>
                <li>Error handling: ✅ JSON responses</li>
            </ul>
        </div>
    </div>
</body>
</html>
