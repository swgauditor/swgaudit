<?php
// Test script for EICAR Download System
header('Content-Type: text/html; charset=utf-8');

function testEndpoint($url, $method = 'GET', $data = null) {
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
    curl_setopt($ch, CURLOPT_TIMEOUT, 10);
    
    if ($method === 'POST') {
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
        curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
    }
    
    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $error = curl_error($ch);
    curl_close($ch);
    
    return [
        'success' => $httpCode === 200 && !$error,
        'http_code' => $httpCode,
        'response' => $response,
        'error' => $error
    ];
}

$baseUrl = 'http://' . $_SERVER['HTTP_HOST'] . dirname($_SERVER['PHP_SELF']) . '/process.php';

$tests = [
    'Health Check' => $baseUrl . '?health=1',
    'Chunk Info' => $baseUrl . '?info=1',
    'Chunk 1' => $baseUrl . '?chunk=1',
    'Chunk 2' => $baseUrl . '?chunk=2', 
    'Chunk 3' => $baseUrl . '?chunk=3',
    'Statistics' => $baseUrl . '?stats=1'
];

?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EICAR System Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-result { margin: 15px 0; padding: 15px; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .test-url { font-family: monospace; background: #e9ecef; padding: 5px; border-radius: 3px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
        h1 { color: #88392B; }
        .header { background: #88392B; color: white; padding: 20px; margin: -20px -20px 20px -20px; border-radius: 8px 8px 0 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>EICAR Download System - API Test</h1>
            <p>Testing all endpoints for functionality</p>
        </div>
        
        <?php foreach ($tests as $testName => $testUrl): ?>
            <?php $result = testEndpoint($testUrl); ?>
            <div class="test-result <?= $result['success'] ? 'success' : 'error' ?>">
                <h3><?= $testName ?> <?= $result['success'] ? 'âœ…' : 'âŒ' ?></h3>
                <div class="test-url"><?= htmlspecialchars($testUrl) ?></div>
                <p><strong>HTTP Code:</strong> <?= $result['http_code'] ?></p>
                <?php if ($result['error']): ?>
                    <p><strong>Error:</strong> <?= htmlspecialchars($result['error']) ?></p>
                <?php endif; ?>
                <?php if ($result['response']): ?>
                    <details>
                        <summary>Response Data</summary>
                        <pre><?= htmlspecialchars(json_encode(json_decode($result['response']), JSON_PRETTY_PRINT)) ?></pre>
                    </details>
                <?php endif; ?>
            </div>
        <?php endforeach; ?>
        
        <div style="margin-top: 30px; padding: 20px; background: #e3f2fd; border-radius: 6px;">
            <h3>POST Test (Log Download)</h3>
            <?php 
            $postData = [
                'timestamp' => date('c'),
                'downloadCount' => 1,
                'chunksProcessed' => 3,
                'assemblyMethod' => 'Test'
            ];
            $postResult = testEndpoint($baseUrl, 'POST', $postData);
            ?>
            <div class="test-result <?= $postResult['success'] ? 'success' : 'error' ?>">
                <p><strong>POST to process.php:</strong> <?= $postResult['success'] ? 'âœ… Success' : 'âŒ Failed' ?></p>
                <p><strong>HTTP Code:</strong> <?= $postResult['http_code'] ?></p>
                <?php if ($postResult['response']): ?>
                    <pre><?= htmlspecialchars(json_encode(json_decode($postResult['response']), JSON_PRETTY_PRINT)) ?></pre>
                <?php endif; ?>
            </div>
        </div>
        
        <div style="margin-top: 20px; text-align: center;">
            <button onclick="location.reload()" style="background: #88392B; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                ðŸ”„ Run Tests Again
            </button>
        </div>
    </div>
</body>
</html>
